<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gov Scenario Builder: AI-Assisted Amendments Activity</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f4f4f4; }
        h1 { color: #333; text-align: center; }
        .step { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        label { display: block; margin: 10px 0 5px; font-weight: bold; }
        select, input[type="radio"], textarea, button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background: #007bff; color: white; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: wait; }
        #output, #starter { white-space: pre-wrap; background: #e9ecef; padding: 15px; border-left: 4px solid #007bff; }
        .loading { color: #007bff; font-style: italic; }
        .error { color: red; background: #ffe6e6; border-left: 4px solid red; }
        .success { color: green; background: #d4edda; border-left: 4px solid #28a745; }
        .tooltip { position: relative; display: inline-block; border-bottom: 1px dotted #000; cursor: help; }
        .tooltip .tooltiptext { visibility: hidden; width: 200px; background: #555; color: #fff; text-align: center; padding: 5px; border-radius: 6px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .format-desc { font-style: italic; color: #666; }
        .ai-status { margin: 10px 0; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üé≠ Gov Scenario Builder</h1>
    <p style="text-align: center; color: #666;">Create your own scenario for the 22nd Amendment, 25th Amendment, Pendleton Act, or Hatch Act. AI helps brainstorm‚Äîadd your twist and explain why it applies!</p>

    <div id="aiStatus" class="ai-status" style="display: none;"></div>

    <div id="wizard" class="step">
        <label>Step 1: Pick a Law/Amendment <span class="tooltip">‚ÑπÔ∏è<span class="tooltiptext">Hover for quick facts!</span></span></label>
        <select id="topic">
            <option value="">Choose...</option>
            <option value="22nd" data-tip="Limits presidents to 2 terms (ratified 1951) to prevent long-term power grabs.">22nd Amendment</option>
            <option value="25th" data-tip="Handles presidential disability/succession (ratified 1967), e.g., VP steps in if prez can't serve.">25th Amendment</option>
            <option value="pendleton" data-tip="1883 Civil Service Reform Act: Merit-based hiring for fed jobs, ends spoils system.">Pendleton Act</option>
            <option value="hatch" data-tip="1939 Act: Bans fed employees from political campaigning on the job to stay neutral.">Hatch Act</option>
        </select>

        <label>Step 2: Choose Format (for your style!)</label>
        <div>
            <input type="radio" id="para" name="format" value="paragraph" checked><label for="para">Short Paragraph <span class="format-desc">(Quick & structured‚Äîgreat for beginners)</span></label><br>
            <input type="radio" id="skit" name="format" value="skit"><label for="skit">Skit Dialogue <span class="format-desc">(Conversational‚Äîrole-play ideas)</span></label><br>
            <input type="radio" id="comic" name="format" value="comic"><label for="comic">Comic Strip Outline <span class="format-desc">(Visual‚Äîadd drawings later!)</span></label>
        </div>

        <label>Step 3: Your Idea (optional‚ÄîAI will build on this)</label>
        <textarea id="userInput" placeholder="E.g., 'The president gets sick during a crisis...' or leave blank for a random starter." rows="3"></textarea>
        <small><em>üí° Tap mic on mobile for voice input.</em></small>

        <button id="loadBtn" onclick="loadAI()">üîÑ Load AI Library (One-Time Setup)</button>
        <button id="genBtn" onclick="generateStarter()" disabled>Get AI Starter Scenario</button>
        <div id="starter"></div>
    </div>

    <div id="builder" class="step" style="display: none;">
        <label>Step 4: Refine with AI (add details or say 'make it funnier')</label>
        <textarea id="refineInput" placeholder="Your turn: What happens next? Why does the law apply?" rows="4"></textarea>
        <button onclick="refineScenario()">AI Refine & Polish</button>
    </div>

    <div id="output" class="step" style="display: none;"></div>
    <button id="exportBtn" onclick="exportScenario()" style="display: none; width: auto;">üìã Copy to Share/Perform</button>

    <script>
        // Load Transformers.js dynamically with error handling
        let scriptLoaded = false;
        let generator = null;

        function loadScript() {
            return new Promise((resolve, reject) => {
                if (scriptLoaded) return resolve(true);
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';
                script.onload = () => {
                    scriptLoaded = true;
                    console.log('‚úÖ Transformers.js script loaded!');
                    resolve(true);
                };
                script.onerror = () => {
                    console.error('‚ùå Failed to load Transformers.js');
                    resolve(false); // Still resolve but flag as failed
                };
                document.head.appendChild(script);
            });
        }

        const starters = {
            '22nd': ['The president wins a third election bid...', 'After two terms, the prez refuses to step down...'],
            '25th': ['The president becomes seriously ill during a national emergency...', 'VP suspects the prez is unable to lead after an accident...'],
            'pendleton': ['A new hire gets the job because of family ties to the boss...', 'A fed agency head promises promotions for campaign donors...'],
            'hatch': ['A government worker posts a campaign ad from their office computer...', 'Fed employees rally for a candidate during lunch at work...']
        };
        const explanations = {
            '22nd': 'This violates the 22nd Amendment because it limits presidents to two terms to avoid power concentration.',
            '25th': 'The 25th Amendment allows the VP and cabinet to declare the president unable to serve, ensuring continuity.',
            'pendleton': 'The Pendleton Act requires merit-based hiring to prevent corruption in civil service.',
            'hatch': 'The Hatch Act prohibits political activity by federal workers on duty to maintain neutrality.'
        };
        const fallbackExamples = {
            '22nd-paragraph': 'In a heated election year, President Elena vows to run for a third term, citing her unmatched leadership. But the Constitution steps in: under the 22nd Amendment, she\'s barred after two terms, sparking a fierce primary battle and lessons in democratic checks.',
            '25th-skit': 'VP: Madam President, the doctors say you need rest after the stroke. We have to invoke Section 4. President: Nonsense! I\'m fine! [Cabinet enters] Cabinet: It\'s for the good of the nation. (25th Amendment activated‚ÄîVP assumes duties temporarily.)',
            'pendleton-comic': 'Panel 1: Boss hands job to nephew üòè Panel 2: Whistleblower: "That violates Pendleton Act‚Äîmerit only!" ‚öñÔ∏è Panel 3: HR investigates, hires fairly. End: Fairness wins! üéâ',
            'hatch-paragraph': 'Fed clerk Jake tweets campaign support from his desk, fired up for the midterms. HR catches it: Hatch Act violation‚Äîno politicking on the clock. He learns: Neutrality keeps government impartial.',
            // Add more as needed for combos
            'default': 'Create a scenario where the law is tested in a modern twist. Explain how it applies to show mastery!'
        };

        let currentTopic = '', currentFormat = 'paragraph', currentScenario = '';

        // Page load: Auto-try script load
        window.addEventListener('DOMContentLoaded', async () => {
            const status = document.getElementById('aiStatus');
            status.style.display = 'block';
            status.innerHTML = '<div class="loading">üîÑ Checking AI setup on page load...</div>';
            const scriptOk = await loadScript();
            if (scriptOk) {
                status.innerHTML = '<div class="success">‚úÖ AI library ready! (Click "Load AI" if needed.)</div>';
                document.getElementById('genBtn').disabled = false;
                document.getElementById('loadBtn').style.display = 'none'; // Hide if auto-success
            } else {
                status.innerHTML = '<div class="error">‚ö†Ô∏è AI library load failed (network?). Using smart examples instead‚Äîstill fun!</div>';
                document.getElementById('genBtn').disabled = false;
            }
            // Tooltips
            document.querySelectorAll('[data-tip]').forEach(el => {
                el.innerHTML += `<span class="tooltiptext">${el.dataset.tip}</span>`;
            });
            // Format tweaks
            document.querySelectorAll('input[name="format"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const input = document.getElementById('userInput');
                    if (e.target.value === 'comic') input.placeholder = 'E.g., Panel 1: The prez collapses...';
                    else if (e.target.value === 'skit') input.placeholder = 'E.g., President: I feel dizzy... VP: We need to invoke...';
                    else input.placeholder = 'E.g., The president gets sick during a crisis...';
                });
            });
        });

        async function loadAI() {
            const status = document.getElementById('aiStatus');
            status.innerHTML = '<div class="loading">üîÑ Loading AI model... (20-30s first time)</div>';
            const btn = document.getElementById('loadBtn');
            btn.disabled = true;
            try {
                const scriptOk = await loadScript();
                if (!scriptOk) throw new Error('Script load failed');
                if (!window.Transformers) throw new Error('Transformers not available');
                generator = await window.Transformers.pipeline('text-generation', 'Xenova/distilgpt2');
                status.innerHTML = '<div class="success">‚úÖ AI fully loaded! Now generate away.</div>';
                document.getElementById('genBtn').disabled = false;
                btn.style.display = 'none';
                console.log('‚úÖ Full AI init success!');
            } catch (err) {
                console.error('‚ùå AI load error:', err);
                status.innerHTML = `<div class="error">AI load issue: ${err.message}. Falling back to examples‚Äîno worries!</div>`;
                document.getElementById('genBtn').disabled = false;
            } finally {
                btn.disabled = false;
            }
        }

        async function generateStarter() {
            const starterDiv = document.getElementById('starter');
            const genBtn = document.getElementById('genBtn');
            genBtn.disabled = true;
            genBtn.textContent = 'Generating...';
            starterDiv.innerHTML = '<div class="loading">‚ú® Crafting your starter...</div>';

            try {
                currentTopic = document.getElementById('topic').value;
                currentFormat = document.querySelector('input[name="format"]:checked').value;
                if (!currentTopic) return alert('Pick a law first!');

                let aiReady = !!generator;
                if (!aiReady) {
                    // Try quick init if not loaded
                    await loadAI();
                    aiReady = !!generator;
                }

                if (aiReady) {
                    const userIdea = document.getElementById('userInput').value || starters[currentTopic][Math.floor(Math.random() * starters[currentTopic].length)];
                    const prompt = `Create a short, realistic scenario about ${currentTopic === '22nd' ? 'the 22nd Amendment' : currentTopic === '25th' ? 'the 25th Amendment' : currentTopic.toUpperCase() + ' Act'}. Start with: "${userIdea}". Format as a ${currentFormat}. End with how/why the law applies. Keep it engaging and accurate.`;

                    console.log('üîÑ AI prompt:', prompt);
                    const output = await generator(prompt, { max_new_tokens: 80, temperature: 0.8, do_sample: true });
                    currentScenario = output[0].generated_text.replace(prompt, '').trim() || output[0].generated_text;
                    starterDiv.innerHTML = `<strong>AI Starter:</strong><br>${currentScenario}`;
                    console.log('‚úÖ AI generation done!');
                } else {
                    // Enhanced fallback
                    const key = `${currentTopic}-${currentFormat}`;
                    currentScenario = fallbackExamples[key] || fallbackExamples['default'];
                    if (document.getElementById('userInput').value) {
                        currentScenario = currentScenario.replace('scenario where', `scenario starting with "${document.getElementById('userInput').value}" where`);
                    }
                    starterDiv.innerHTML = `<div class="fallback"><strong>Smart Starter (Example Mode):</strong><br>${currentScenario}<br><small>(AI offline‚Äîedit this to make it yours!)</small></div>`;
                }

                document.getElementById('wizard').style.display = 'none';
                document.getElementById('builder').style.display = 'block';
            } catch (err) {
                console.error('‚ùå Starter error:', err);
                starterDiv.innerHTML = `<div class="error">Generation snag: ${err.message}. Quick start: "${document.getElementById('userInput').value || starters[currentTopic]?.[0] || 'The president runs for a third term...'}" Use the fallback above!</div>`;
                document.getElementById('wizard').style.display = 'none';
                document.getElementById('builder').style.display = 'block';
            } finally {
                genBtn.disabled = false;
                genBtn.textContent = 'Get AI Starter Scenario';
            }
        }

        async function refineScenario() {
            const outputDiv = document.getElementById('output');
            const refineBtn = event.target;
            refineBtn.disabled = true;
            refineBtn.textContent = 'Refining...';
            outputDiv.innerHTML = '<div class="loading">‚ú® AI polishing your ideas...</div>';
            outputDiv.style.display = 'block';

            try {
                const refine = document.getElementById('refineInput').value;
                if (!refine) return alert('Add your idea to refine!');

                let aiReady = !!generator;
                if (!aiReady) await loadAI(); // Retry

                if (aiReady) {
                    const prompt = `${currentScenario}\nUser adds: "${refine}". Continue/refine the ${currentFormat} scenario, ensuring it accurately shows the law in action. Add creativity!`;
                    console.log('üîÑ Refine prompt:', prompt);
                    const output = await generator(prompt, { max_new_tokens: 60, temperature: 0.7, do_sample: true });
                    currentScenario = output[0].generated_text.replace(prompt, '').trim() + `\n\n**Why It Applies:** ${explanations[currentTopic]}`;
                } else {
                    currentScenario += `\n\nYour Twist: ${refine}\n\n**Why It Applies:** ${explanations[currentTopic]}`;
                }

                outputDiv.innerHTML = currentScenario;
                document.getElementById('builder').style.display = 'none';
                document.getElementById('exportBtn').style.display = 'inline-block';
                console.log('‚úÖ Refine done!');
            } catch (err) {
                console.error('‚ùå Refine error:', err);
                currentScenario += `\n\nYour Twist: ${document.getElementById('refineInput').value}\n\n**Why It Applies:** ${explanations[currentTopic]}`;
                outputDiv.innerHTML = `<div class="error">Refine hiccup: ${err.message}. Here's your updated version:<br>${currentScenario}</div>`;
                document.getElementById('exportBtn').style.display = 'inline-block';
            } finally {
                refineBtn.disabled = false;
                refineBtn.textContent = 'AI Refine & Polish';
            }
        }

        function exportScenario() {
            navigator.clipboard.writeText(currentScenario).then(() => alert('Copied! Paste into Google Docs or perform for class.'));
        }
    </script>
</body>
</html>
